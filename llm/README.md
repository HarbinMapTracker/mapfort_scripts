# 驾驶员历史出行分析服务

本服务提供驾驶员历史驾驶模式分析和休息建议功能，通过分析历史出行数据，为司机提供安全和健康的驾驶建议。

## 功能特点

- **历史出行情况分析**：分析司机的历史驾驶模式，包括总行程数、驾驶时长、夜间驾驶比例等
- **休息建议**：基于驾驶模式提供个性化的休息建议
- **模拟时间功能**：支持传入模拟时间点进行分析，便于测试和演示

## 技术栈

- FastAPI: 高性能Web框架
- SQLAlchemy: ORM数据库操作
- PostgreSQL: 数据存储
- Pydantic: 数据验证和序列化
- Uvicorn: ASGI服务器

## 安装指南

本项目使用uv作为包管理工具。克隆项目后，执行以下命令安装依赖：

```bash
uv pip install -r requirements.txt
```

或者直接使用项目配置文件:

```bash
uv pip install .
```

## 启动服务

```bash
python run.py
```

服务启动后，可以通过以下地址访问API文档：
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## API接口

服务提供三个主要接口：

### 1. 驾驶模式分析

**端点**: `/driving-patterns/`

**功能**：分析司机的历史驾驶模式，返回包括总行程数、驾驶时长、夜间驾驶比例等数据。

**查询参数:**

- `devid`: 驾驶员设备ID (必需)
- `simulated_time`: 模拟当前时间 (Unix时间戳，可选)
- `days_back`: 分析的历史天数 (默认: 7)

**示例请求:**

```bash
curl -X GET "http://localhost:8000/driving-patterns/?devid=100320790&simulated_time=1420667113&days_back=7"
```

**响应:**

```json
{
  "total_trips": 67,
  "total_driving_time_minutes": 2023.4,
  "average_trip_duration_minutes": 30.2,
  "night_driving_percentage": 18.3,
  "continuous_driving_incidents": 1,
  "longest_continuous_driving_minutes": 292.6
}
```

### 2. 休息建议

**端点**: `/rest-recommendation/`

**功能**：基于驾驶员的历史数据提供休息建议，支持规则引擎和LLM两种模式，以及流式/非流式输出。

**查询参数:**

- `devid`: 驾驶员设备ID (必需)
- `simulated_time`: 模拟当前时间 (Unix时间戳，可选)
- `days_back`: 分析的历史天数 (默认: 7)
- `use_llm`: 是否使用LLM提供建议 (默认: false)
- `streaming`: 当use_llm=true时，是否使用流式输出 (默认: false)

**示例请求:**

```bash
curl -X GET "http://localhost:8000/rest-recommendation/?devid=100320790&simulated_time=1420667113&days_back=7&use_llm=true"
```

**响应 (非流式):**

```json
{
  "needs_rest": true,
  "reason": "由LLM分析得出",
  "recommendation": "您好，[驾驶员ID: 100320790]驾驶员！\n\n我是您的专业驾驶安全顾问。非常感谢您提供的驾驶数据，这能帮助我们更好地了解您的驾驶习惯，从而为您提供更精准的安全建议。我们的目标是帮助您保持安全、舒适的驾驶状态，确保每一次出行都能平安顺利。\n\n根据您提供的宝贵数据，我们进行了分析，并为您准备了以下的休息建议：\n\n**1. 是否需要休息及原因**\n\n**是的，您需要非常重视休息的必要性。**\n\n尽管您的平均行程时长仅为30.2分钟，表明您很多行程是短途的，但这组数据中有一个非常关键的信息引起了我们的注意：**您有过一次长达 292.6 分钟（约合 4小时53分钟）的连续驾驶记录。**\n\n长时间的连续驾驶是导致驾驶疲劳的主要原因之一。即使您当下可能没有感觉到非常疲惫，但长时间保持高度集中的注意力、固定的驾驶姿势以及应对复杂的交通环境，都会逐渐消耗您的精力，降低反应速度、判断能力，并增加发生危险的概率。接近5小时的连续驾驶已经显著超过了大多数安全驾驶建议的连续时长上限。\n\n因此，虽然您总体的驾驶模式可能偏向短途，但有过如此长时间的连续驾驶事件，意味着您在面对较长行程时存在疲劳驾驶的风险，这需要引起您的重视并在今后的驾驶中进行调整。\n\n**2. 详细的休息建议**\n\n为了避免疲劳驾驶带来的风险，特别是避免再次发生近5小时的连续驾驶情况，我们强烈建议您采纳以下休息策略：\n\n*   **休息频率：**\n    *   **基本原则：** 每连续驾驶2-3小时，就应该进行一次休息。不要等到感觉疲惫了再休息，疲劳往往是累积的，一旦感觉明显疲惫，反应能力已经受到影响。\n    *   **根据时长调整：** 如果您的行程预计会超过2-3小时，请务必提前规划好休息点。\n    *   **考虑其他因素：** 如果在恶劣天气、拥堵路段驾驶，或是在夜间驾驶（您的夜间驾驶比例为18.3%，夜间驾驶更容易疲劳），您可能需要更频繁地休息，例如每1.5-2小时休息一次。\n\n*   **休息时长：**\n    *   **最低时长：** 每次休息建议至少持续 **15-20分钟**。这段时间足以让您下车活动一下，放松身体和精神。\n    *   **理想时长：** 对于较长的旅程或感觉稍有疲倦时，建议休息 **30分钟或更长**。这段时间可以进行更充分的放松，甚至可以考虑短暂的小睡（动力小憩，Power Nap，约20-30分钟，避免进入深度睡眠后醒来反而更困）。\n\n*   **如何安排休息：**\n    *   **提前规划：** 在规划长途驾驶路线时，提前确定好沿途的服务区、休息站或安全的停车点。不要随意在高速公路应急车道停车（除非紧急情况）。\n    *   **有效利用休息时间：**\n        *   **离开车辆：** 一定要下车活动！伸展身体，走动走动，促进血液循环。\n        *   **呼吸新鲜空气：** 在室外走动，呼吸新鲜空气有助于提神。\n        *   **补充水分和能量：** 喝水或健康的非咖啡因饮料。吃一些清淡的食物或水果，避免油腻或糖分过高的食物。\n        *   **放松眼睛：** 眺望远方，避免长时间盯着近距离的物体（如手机屏幕）。\n        *   **短暂小睡（可选）：** 如果条件允许且感觉疲惫，可以尝试短暂小睡，但设置闹钟，避免睡过头。\n    *   **避免无效休息：** 仅仅坐在车内玩手机或闭目养神，休息效果有限，无法有效缓解驾驶疲劳。\n\n**3. 长期驾驶习惯调整建议**\n\n为了您的长期驾驶安全和健康，除了在长途驾驶时注意休息，也请考虑以下几点调整：\n\n*   **认识疲劳的信号：** 学会识别疲劳的早期信号，例如：眼皮沉重、频繁眨眼、注意力不集中、思维开始游离、频繁打哈欠、身体僵硬不适、驾驶动作变得机械或出现小错误（如压线）。一旦出现这些信号，请立即寻找安全地点休息。\n*   **保证充足睡眠：** 任何一次驾驶（特别是长途驾驶）前一晚，请务必保证充足、高质量的睡眠。疲劳驾驶的根源往往是睡眠不足。\n*   **避免在易疲劳时段驾驶：** 您的数据中有18.3%的夜间驾驶。人体在凌晨2点至5点，以及下午1点至3点通常是生理上的低谷，容易感到疲惫。如果必须在这些时段驾驶，请务必提高警惕，并增加休息频率。\n*   **保持车内空气流通：** 密闭的车厢和污浊的空气会加速疲劳，适时开窗通风或开启外循环。\n*   **避免分心驾驶：** 分心会消耗额外的脑力，加速疲劳的产生。驾驶时请专注于路况，避免使用手机或其他分散注意力的行为。\n\n总而言之，您有过一次长时间连续驾驶的记录，这是需要特别关注的风险点。希望您能从这次数据分析中认识到潜在的疲劳驾驶风险，并在未来的驾驶中严格遵守“逢2-3小时必休息”的原则，每次休息至少15-20分钟，并利用休息时间有效放松身心。同时，养成良好的作息习惯，保证充足睡眠，是避免疲劳驾驶的根本。\n\n为了您的安全和您家人的幸福，请将安全放在第一位。希望这些建议能帮助您提升驾驶安全意识，享受每一次愉快的旅程！\n\n祝您一路平安！"
}
```

**流式响应格式:**

```text
data: {"content": "您的驾驶数据显示"}
data: {"content": "连续驾驶时间较长，"}
...
data: {"needs_rest": true, "recommendation": "完整建议内容...", "reason": "由LLM分析得出", "finished": true}
```

### 3. 综合驾驶员分析

**端点**: `/driver-analysis/`

**功能**：结合了上述两个接口的功能，同时返回驾驶模式分析和休息建议。

**查询参数:**
- `devid`: 驾驶员设备ID (必需)
- `simulated_time`: 模拟当前时间 (Unix时间戳，可选)
- `days_back`: 分析的历史天数 (默认: 7)
- `use_llm`: 是否使用LLM提供休息建议 (默认: false)

**示例请求:**

```bash
curl -X GET "http://localhost:8000/driver-analysis/?devid=100320790&simulated_time=1420667113&days_back=7"
```

**响应:**

```json
{
  "devid": "100320790",
  "driving_patterns": {
    "total_trips": 35,
    "total_driving_time_minutes": 1254.7,
    "average_trip_duration_minutes": 35.8,
    "night_driving_percentage": 22.5,
    "continuous_driving_incidents": 2,
    "longest_continuous_driving_minutes": 285.3
  },
  "rest_recommendation": {
    "needs_rest": true,
    "reason": "您有2次连续驾驶超过4小时的记录",
    "recommendation": "建议每连续驾驶2小时后至少休息15分钟。建议调整您的驾驶时间，减少夜间驾驶（23:00-5:00）"
  }
}
```

## 数据库信息

服务连接到PostgreSQL数据库，使用`dwd_trip_info`表获取驾驶员历史出行记录：

- **traj_id**: 轨迹的唯一标识符
- **devid**: 设备ID，标识司机或车辆
- **travel_time**: 出行耗时（秒）
- **begin_time**: 出行开始时间（Unix时间戳）
- **end_time**: 出行结束时间（Unix时间戳）

## 贡献指南

如需贡献，请提交Pull Request或Issue。
